# Import 数据导入

<Detail title="查看源码">

```json
{
  "name": "工单列表",
  "version": "1.0.0",
  "decription": "工单列表",
  "bind": {
    "model": "ticket"
  },
  "apis": {},
  "actions": {
    "create": {
      "type": "button",
      "props": { "label": "添加工单", "icon": "fas fa-plus" }
    },
    "import": {
      "props": {
        "api": {
          "setting": "/api/xiang/import/ticket/setting",
          "mapping": "/api/xiang/import/ticket/mapping",
          "mapping_setting": "/api/xiang/import/ticket/mapping/setting",
          "preview": "/api/xiang/import/ticket/data",
          "preview_setting": "/api/xiang/import/ticket/data/setting",
          "import": "/api/xiang/import/ticket"
        }
      }
    },
    "pagination": {}
  },
  "columns": {},
  "filters": {},
  "list": {},
  "edit": {},
  "view": {}
}
```

</Detail>

查看 [代码示例](#示例代码)

<blockquote>
  <p>
    文件导入功能，通常用于Excel表格导入。
  </p>
  <p>
    使用Tables里面的数据导入组件作为处理器使用。
  </p>
  <p>
    本章节介绍Excel导入功能。
  </p>

</blockquote>

## 处理器清单

| 处理器                      | 说明                       |
| --------------------------- | -------------------------- |
| xiang.import.Run            | 开始运行导入功能           |
| xiang.import.Data           | 获取表格的数据             |
| xiang.import.Setting        | 获取表格的映射字段 setting |
| xiang.import.DataSetting    | 获取映射数据               |
| xiang.import.Mapping        | 获取映射                   |
| xiang.import.MappingSetting | 获取映射数据               |

## API 清单

| 接口                                         | 说明                       |
| -------------------------------------------- | -------------------------- |
| /api/xiang/import/<表格名称>/setting         | 获取表格的 Setting         |
| /api/xiang/import/<表格名称>/mapping         | 获取表格的映射字段         |
| /api/xiang/import/<表格名称>/mapping/setting | 获取表格的映射字段 setting |
| /api/xiang/import/<表格名称>/data            | 获取数据                   |
| /api/xiang/import/<表格名称>/data/setting    | 获取数据的 setting         |
| /api/xiang/import/<表格名称>                 | 导入数据接口               |

```json
{
  "setting": "/api/xiang/import/ticket/setting",
  "mapping": "/api/xiang/import/ticket/mapping",
  "mapping_setting": "/api/xiang/import/ticket/mapping/setting",
  "preview": "/api/xiang/import/ticket/data",
  "preview_setting": "/api/xiang/import/ticket/data/setting",
  "import": "/api/xiang/import/ticket"
}
```

## 代码示例：

新增 models 目录文件`/models/ticket.mod.yao`：

<Detail title="查看源码">

```json
{
  "name": "工单表",
  "table": {
    "name": "ticket",
    "comment": "工单表"
  },
  "columns": [
    { "label": "ID", "name": "id", "type": "ID" },
    {
      "label": "昵称",
      "name": "name",
      "type": "string",
      "length": 20,
      "comment": "昵称",
      "index": true
    },
    {
      "label": "电话号码",
      "name": "phone",
      "type": "string",
      "comment": "电话号码",
      "nullable": true
    },
    {
      "label": "用户性别",
      "comment": "用户性别",
      "name": "gender",
      "type": "string",
      "default": ""
    },

    {
      "label": "区域",
      "name": "area",
      "type": "string",
      "nullable": true,
      "comment": "区域"
    }
  ],
  "option": {
    "timestamps": true,
    "soft_deletes": true
  },
  "values": []
}
```

</Detail>

新增 table 目录文件`/tables/ticket.tab.yao`：

<Detail title="查看源码">

```json
{
  "name": "::ticket",
  "action": {
    "bind": {
      "model": "ticket"
    }
  },
  "layout": {
    "primary": "id",
    "header": {
      "preset": {}
    },
    "filter": {
      "columns": [],
      "actions": [
        {
          "icon": "icon-plus",
          "width": 3,
          "action": {
            "Common.openModal": {
              "width": 1200,
              "Form": {
                "type": "edit",
                "model": "upload"
              }
            }
          },
          "title": "导入"
        }
      ]
    }
  }
}
```

新增`/forms/upload.form.yao`文件:

```json
{
  "action": {
    "guard": "bearer-jwt",
    "bind": {
      "model": "ticket",
      "option": {
        "withs": {}
      }
    },
    "find": {
      "process": "scripts.upload.Find"
    },
    "delete": {
      "process": "scripts.upload.Find"
    },
    "save": {
      "process": "scripts.upload.UploadSave"
    }
  },
  "layout": {
    "form": {
      "sections": [
        {
          "columns": [
            {
              "width": 24,
              "name": "文件"
            }
          ]
        }
      ],
      "props": {}
    },
    "actions": [
      {
        "title": "上传",
        "icon": "icon-check",
        "showWhenAdd": true,
        "showWhenView": true,
        "style": "primary",
        "action": [
          {
            "name": "Submit",
            "type": "Form.submit",
            "payload": {}
          },
          {
            "name": "Back",
            "type": "Common.closeModal",
            "payload": {}
          }
        ]
      },
      {
        "title": "下载导入模板",
        "icon": "icon-download",
        "showWhenAdd": true,
        "showWhenView": true,
        "action": {
          "Common.historyPush": {
            "pathname": "/ticket.xlsx",
            "public": true
          }
        }
      },
      {
        "title": "返回",
        "divideLine": true,
        "showWhenAdd": true,
        "showWhenView": true,
        "icon": "icon-arrow-left",
        "action": [
          {
            "name": "closeModal",
            "type": "Common.closeModal",
            "payload": {}
          }
        ]
      }
    ],
    "primary": "id",
    "operation": {
      "preset": {
        "save": {
          "back": true
        },
        "back": {}
      },
      "actions": []
    }
  },
  "fields": {
    "form": {
      "文件": {
        "edit": {
          "props": {
            "filetype": "file",
            "$api": { "process": "fs.system.Upload" }
          },
          "type": "Upload",

          "bind": "file"
        },
        "bind": "file"
      }
    }
  },
  "name": "上传"
}
```

</Detail>

导入 Excel 文件，新增目录文件`/imports/ticket.imp.yao`：

应用目录结构:

```bash
├── apis        # 用于存放接口描述文件
│
├──tables
|  └──ticket.tab.yao #导入excel的table
|
├── models        # 用于存放数据模型描述文件
│
├── db
└── imports           #用于导入数据的映射文件
| └── ticket.imp.yao
|
|──scripts
|  └──imports
|       └──ticket.js
|
|
└── app.yao
```

编写代码`ticket.imp.yao`：

<Detail title="查看源码">

```json
{
  "title": "导入工单",
  "process": "scripts.imports.ticket.Import",
  "output": "scripts.imports.ticket.Output",
  "columns": [
    {
      "label": "昵称",
      "name": "name",
      "match": ["昵称", "昵称", "name"],
      "rules": []
    },
    {
      "label": "手机",
      "name": "phone",
      "match": ["手机", "手机", "phone"],
      "rules": []
    },
    {
      "label": "性别",
      "name": "gender",
      "match": ["性别", "性别", "gender"],
      "rules": []
    },
    {
      "label": "地区",
      "name": "area",
      "match": ["地区", "地区", "area"],
      "rules": []
    }
  ],
  "option": {
    "autoMatching": true,
    "chunkSize": 200,
    "logging": "error",
    "mappingPreview": "auto",
    "dataPreview": "auto",
    "templateLink": "/somelinke/download/xxx"
  },
  "rules": {}
}
```

</Detail>

编写代码`ticket/upload.js`：

<Detail title="查看源码">

</Detail>

编写代码`/scripts/imports/ticket.js`：

```javascript
function Import(columns, data) {
  // todo 处理导入逻辑

  // 打印隐射关系
  console.log(columns);

  // 打印获取的数据
  console.log(data);
  // todo 把数据保存

  for (var i in data) {
    Process("models.ticket.save", {
      name: data[i][0],
      phone: data[i][1],
      gender: data[i][2],
      area: data[i][3],
    });
  }

  var success = 0;
  var fail = 0;

  return [success, fail];
}
function Output(data) {
  // todo 处理导入后的逻辑，导入后会自动调用这个函数："output": "scripts.imports.ticket.Output",
  return data;
}
```

<Div style={{ display: "flex", justifyContent: "space-between" }}>
  <Link type="prev" title="Chart" link="手册/Widgets/Chart"></Link>
  <Link type="next" title="Store" link="手册/Widgets/Store"></Link>
</Div>
