# 使用会话数据

<blockquote>
  <p>
    可以使用 <strong>session.*</strong>,<strong>Captcha</strong>,
    <strong>PasswordValidate</strong>
    <strong>JwtMake</strong>,<strong>JwtValidate</strong>等处理器，实现自定义用户登录、用户身份鉴权。
  </p>
  <p>可以在数据流、JS编写的处理器和数据表格中使用登录时候，设置的会话数据。</p>
</blockquote>

## 账号密码登录

**账号密码登录流程：**

1. 用户在登录页面，填写账号名称、验证码和密码，点击按钮提交到指定 API。

2. API 接收账号名和密码信息，转交指定的处理器，校验密码，签发 JWT 令牌。

**处理器密码校验逻辑：**

1.  调用 **CaptchaValidate** 处理器，校验验证码。

2.  调用数据模型处理器，通过账号名称查询用户数据记录，获得加密存储的密码信息。

3.  调用 **PasswordValidate** 处理器，校验用户填写密码是否正确。

4.  签发 JWT 令牌，设定会话信息。

### 第一步: 用户数据模型

编写 `user.mod.yao` 放置在应用 `models` 目录。

<Detail title="查看源码">

```json
{
  "name": "用户",
  "table": { "name": "user", "comment": "用户表" },
  "columns": [
    { "label": "ID", "name": "id", "type": "ID", "comment": "ID" },
    {
      "label": "供应商",
      "name": "supplier_id",
      "type": "bigInteger",
      "index": true,
      "comment": "所属供应商ID"
    },
    {
      "label": "邮箱",
      "name": "email",
      "type": "string",
      "index": true,
      "comment": "用户邮箱地址",
      "validations": [
        {
          "method": "typeof",
          "args": ["string"],
          "message": "{{input}}类型错误, {{label}}应该为字符串"
        },
        {
          "method": "email",
          "args": [],
          "message": "{{input}}不是邮箱地址"
        }
      ]
    },
    {
      "label": "登录密码",
      "name": "password",
      "type": "string",
      "crypt": "PASSWORD",
      "index": true,
      "nullable": true,
      "validations": [
        {
          "method": "typeof",
          "args": ["string"],
          "message": "{{input}}类型错误, {{label}}应该为字符串"
        },
        {
          "method": "minLength",
          "args": [8],
          "message": "{{label}}不能少于8位。"
        }
      ]
    },
    {
      "label": "姓名",
      "name": "name",
      "type": "string",
      "index": true,
      "comment": "用户姓名"
    }
  ],
  "values": [
    {
      "id": 1,
      "supplier_id": 1,
      "name": "张无忌",
      "email": "zhang@yaoapps.com",
      "password": "5MCIXQYrR"
    },
    {
      "id": 2,
      "supplier_id": 1,
      "name": "李光富",
      "email": "li@yaoapps.com",
      "password": "VHP79MBKf"
    },
    {
      "id": 3,
      "supplier_id": 2,
      "name": "李木婷",
      "email": "mu@yaoapps.com",
      "password": "Ert6a1Ub8"
    },
    {
      "id": 4,
      "supplier_id": 2,
      "name": "赵长青",
      "email": "zhao@yaoapps.com",
      "password": "7CDcn4pcU"
    }
  ]
}
```

</Detail>

**创建数据表 & 添加默认用户:**

```bash
yao migrate -n user --reset
```

### 第二步: 登录处理器

编写 `/scripts/login.js`处理登录逻辑:

<Detail title="查看源码">

```javascript
/**
 * 登录处理
 * @param {*} payload
 * @returns
 */
function Login(payload) {
  // 验证验证码
  var captcha = Process(
    "xiang.helper.CaptchaValidate",
    payload.captcha.id,
    payload.captcha.code
  );

  if (captcha !== true) {
    throw new Exception("验证码不正确!", 400);
  }
  var account = payload.mobile;
  if (!account) {
    account = payload.email;
  }
  var user = Process("models.user.get", {
    wheres: [{ column: "email", value: account }],
    limit: 1,
  });
  if (!user || !user.length) {
    throw new Exception("用户不存在", 400);
  }
  // 验证密码
  var password_validate = Process(
    "xiang.helper.PasswordValidate",
    payload.password,
    user[0].password
  );
  if (password_validate !== true) {
    throw new Exception("密码不正确!", 400);
  }

  // 增加token等信息
  const session_id = payload.sid;
  var jwt = Process(
    "xiang.helper.JWTMake",
    user[0].id,
    { user_name: user[0].name },
    {
      timeout: 28800,
      sid: session_id,
    }
  );
  Process("session.set", "user", user[0], 28800);
  Process("session.set", "token", jwt.token, 28800);
  Process("session.set", "user_id", user[0].id, 28800);
  delete user[0].password;
  return {
    sid: session_id,
    user: user[0],
    menus: Process("flows.app.menu"),
    token: jwt.token,
    expires_at: jwt.expires_at,
  };
}
```

</Detail>

<Notice type="success">
  技巧：通过js来处理复杂逻辑,把验证密码,签发令牌等复杂操作写在js脚本中.
</Notice>

<Notice type="success">
  技巧: 为便于调试，可在登录逻辑调试成功后，添加验证码校验节点。
</Notice>

<Notice type="warning">
  注意：由于一些历史原因, yao 内建的登录界面登录提交信息中，用户字段名称固定为
  <strong>mobile</strong>, 在后续的版本中将允许在应用描述文件中定义。
</Notice>

### 第三步: 设置登录 API

编写接口描述文件 `/logins/user.login.yao`,把登录处理器指定为刚刚写的`scripts.login.Login`

描述文件内容:

<Detail title="查看源码">

```json
{
  "name": "::User Login",
  "action": {
    "process": "scripts.login.Login",
    "args": [":payload"]
  },
  "layout": {
    "entry": "/x/Dashboard/kanban",
    "slogan": "::Make Your Dream With Yao App Engine",
    "site": "https://yaoapps.com/?from=instance-user-login"
  }
}
```

</Detail>

**接口调试:**

启动服务:

```bash
yao start
```

读取验证码接口:

```bash
curl http://127.0.0.1:5099/api/__yao/login/user/captcha?type=digit
```

<Notice type="success">
  技巧：设置环境变量开启 debug mode , 发起请求后，可以在服务日志中查看验证码 id
  和 code, 用于调试。
</Notice>

登录接口:

```bash
curl -X POST http://127.0.0.1:5099/api/__yao/login/user \
    -H 'Content-Type: application/json' \
    -d '{"mobile":"zhang@yaoapps.com", "password": "5MCIXQYrR", "captcha":{"id":1024, "code":"xv98"}}'
```

## 使用会话数据

用户成功登录设定的会话数据，可以在数据流, JS 脚本和数据表格中使用。

### 在数据流中使用

编写 `inspect.flow.yao` 放置在应用 `flows/user/` 目录。

```json
{
  "label": "当前用户信息",
  "version": "1.0.0",
  "description": "当前用户信息",
  "nodes": [
    {
      "name": "会话",
      "process": "session.Get",
      "args": ["user"]
    },
    {
      "name": "打印",
      "process": "xiang.helper.Print",
      "args": ["{{$res.会话}}"]
    }
  ],
  "output": "{{$res.会话}}"
}
```

**运行调试:**

修改`/tables/product.tab.yao`的 `action`,加入 刚刚写好的`before:search`

```json
  "action": {
    "bind": { "model": "product" },
    "save": {
      "guard": "scripts.guard.Validate"
    },
    "before:search": "flows.user.inspect"
  },

```

启动服务，开启调试模式:

```bash
yao start --debug
```

登录后,访问菜单产品列表 `http://127.0.0.1:5099/admin/x/Table/product`可以看到控制台打印的用户信息:

```json
{
  "email": "xiang@iqka.com",
  "extra": {
    "sex": "男"
  },
  "id": 1,
  "mobile": null,
  "name": "管理员",
  "status": "enabled",
  "type": "admin"
}
```

### 在 JS 脚本中使用

编写 `user.js` 放置在应用 `scripts` 目录。

```javascript
function Inspect() {
  return Process("session.Get", "user");
}
```

### 在数据表格中使用

可直接在数据表格 `apis.*.default` 中引用会话变量。

<Detail title="查看源码">

```json
{
  "name": "产品",
  "action": {
    "bind": { "model": "product" },
    "save": {
      "guard": "scripts.guard.Validate"
    },
    "before:search": "flows.user.inspect",
    "search": {
      "default": [
        {
          "wheres": [{ "column": "id", "value": "{{$user.id}}" }],
          "orders": [{ "column": "id", "options": "desc" }]
        },
        1,
        10
      ]
    }
  },
  "layout": {
    "header": { "preset": {} },
    "table": {
      "columns": [
        { "name": "联动", "width": 200 },
        { "name": "名称", "width": 200 },
        { "name": "备注", "width": 200 },
        { "name": "上架状态", "width": 200 },
        { "name": "图集", "width": 200 }
      ]
    }
  },
  "fields": {
    "table": {
      "联动": {
        "bind": "online",
        "view": {
          "bind": "new_field",
          "type": "Text",
          "compute": {
            "process": "Concat",
            "args": ["$C(row.name)", "(", "$C(row.remark)", ")"]
          }
        },
        "edit": {
          "type": "Select",
          "props": {
            "options": [
              { "label": "已上架", "value": true },
              { "label": "已下架", "value": false }
            ]
          }
        }
      },
      "图集": {
        "bind": "images",
        "view": { "type": "Image", "compute": "Download" },
        "edit": {
          "type": "Upload",
          "compute": "Upload",
          "props": {
            "filetype": "image",
            "$api": { "process": "fs.system.Upload" }
          }
        }
      }
    }
  }
}
```

</Detail>

<Div style={{ display: "flex", justifyContent: "space-between" }}>
  <Link type="prev" title="复杂数据查询" link="进阶/复杂数据查询"></Link>
  <Link type="next" title="使用缓存" link="进阶/使用缓存"></Link>
</Div>
