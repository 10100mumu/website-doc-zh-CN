# 入门指南

从零到一创建一个客户管理模块，实现客户资料增删改查。

## 安装

### MacOS / Linux

在终端下运行一下脚本:

```bash
curl -fsSL https://demo-crm.iqka.com/releases/0.9.22/install.sh | bash
```

### Windows

安装 Cygwin [下载地址](https://cygwin.com/install.html) :

- 在 Windows 终端下运行: `setup-x86.exe -q -O -s https://mirrors.aliyun.com/cygwin/ -R C:\cygwin_root -P lynx,wget`

- 安装 `apt-cyg`，在 **Cygwin 终端** 中运行: `lynx -source rawgit.com/transcode-open/apt-cyg/master/apt-cyg > apt-cyg install apt-cyg /bin`

- 安装 `curl`: `apt-cyg install curl`

在 **Cygwin 终端** 中运行:

```bash
curl -fsSL https://demo-crm.iqka.com/releases/0.9.11/install.sh | bash
```

### Docker (推荐)

1. 安装 Docker [安装并下载 Docker](https://docs.docker.com/get-docker/)

2. 创建并启动容器: `docker run -d --name yao -v /your-project-root:/data/app -p 5099:5099 yaoapp/yao:0.9.22`

## 开发

### 1. 创建项目

创建一个空目录，作为项目目录，并使用 `yao init` 命令，对项目目录初始化。打开命令行终端，**在项目跟录下运行**:

```bash
cd your-project
yao init
```

命令成功执行，将创建以下文件和目录。

```bash
├── yao_modules # 用于存放公共数据模型文件、数业流文件、数据流脚本等
├── apis        # 用于存放接口描述文件
├── data        # 用于存放应用产生的文件，如图片,PDF等
├── db          # 用于存放 SQLite 数据库文件
│   └── xiang.db
├── flows     # 用于存放数据流描述文件
├── models    # 用于存放数据模型描述文件
├── plugins   # 用于存放GRPC插件文件
├── tables    # 用于数据表格界面描述文件
└── ui        # 静态文件服务器文件目录，可以放置自定义前端制品，该目录下文件可通过 http://host:port/文件名称 访问。
└── app.json  # 应用配置文件, 用来定义应用名称等
```

### 2. 设计数据模型

设计一张数据表 `customer`，用于存放客户资料数据。数据表结构如下:

| 字段       | 类型       | 长度/参数                  | 默认值  | 说明                      |
| ---------- | ---------- | -------------------------- | ------- | ------------------------- |
| id         | ID         |                            |         | 数据表 ID                 |
| channel_id | bigInteger |                            |         | 客户来源                  |
| name       | string     | 80                         |         | 客户姓名                  |
| company    | string     | 200                        |         | 公司名称                  |
| gender     | integer    |                            | 0       | 性别 0, 未知，1 男，2，女 |
| birthday   | date       |                            |         | 生日                      |
| desc       | text       |                            |         | 简历                      |
| status     | enum       | ["enabled"], ["disabled"], | enabled | 状态                      |

#### 创建数据模型描述文件

在项目 `models` 目录下，创建数据模型描述文件 `customer.mod.yao`

```json
{
  "name": "客户",
  "table": {
    "name": "customer",
    "comment": "客户表"
  },
  "columns": [
    {
      "label": "ID",
      "name": "id",
      "type": "ID",
      "comment": "ID"
    },
    {
      "label": "来源",
      "name": "channel_id",
      "type": "bigInteger",
      "comment": "客户来源",
      "nullable": true,
      "index": true
    },
    {
      "label": "姓名",
      "name": "name",
      "type": "string",
      "length": 80,
      "comment": "客户姓名",
      "nullable": true,
      "index": true
    },
    {
      "label": "公司",
      "name": "company",
      "type": "string",
      "length": 200,
      "comment": "公司全称",
      "nullable": true,
      "index": true
    },
    {
      "label": "性别",
      "name": "gender",
      "type": "integer",
      "comment": "性别",
      "default": 0,
      "index": true
    },
    {
      "label": "生日",
      "name": "birthday",
      "type": "date",
      "comment": "性别",
      "nullable": true,
      "index": true
    },
    {
      "label": "介绍",
      "name": "desc",
      "type": "text",
      "comment": "介绍",
      "nullable": true
    },
    {
      "label": "状态",
      "name": "status",
      "type": "enum",
      "default": "enabled",
      "option": ["enabled", "disabled"],
      "comment": "状态 enabled 开启, disabled 关闭",
      "index": true
    }
  ],
  "option": {
    "timestamps": true,
    "soft_deletes": true
  },
  "values": [
    {
      "id": 1,
      "name": "莉莉",
      "company": "yaoapps.com"
    }
  ]
}
```

#### 创建数据表

使用 `yao migrate` 命令创建数据表，打开命令行终端，**在项目根录下运行**:

```bash
yao migrate
```

可以使用 `yao run` 命令查询数据，打开命令行终端，**在项目根录下运行**:

```bash
yao run models.customer.find 1
```

### 3. 编写界面描述

在项目 `tables` 目录下，创建数据表格描述文件 `customer.tab.yao`

```json
{
  "name": "客户",
  "version": "1.0.0",
  "decription": "客户管理数据表格",
  "bind": {
    "model": "customer"
  },
  "columns": {},
  "filters": {
    "关键词": { "@": "filter.关键词", "in": ["where.name.match"] },
    "排序": { "@": "filter.排序" }
  },
  "list": {
    "primary": "id",
    "layout": {
      "columns": [
        { "name": "ID", "width": 80 },
        { "name": "公司", "width": 200 },
        { "name": "姓名", "width": 100 },
        { "name": "性别", "width": 80 },
        { "name": "生日", "width": 100 },
        { "name": "来源", "width": 80 },
        { "name": "状态", "width": 140 },
        { "name": "更新时间", "width": 160 }
      ],
      "filters": [{ "name": "关键词" }, { "name": "来源", "width": 3 }]
    },
    "actions": {
      "create": {
        "type": "button",
        "props": { "label": "添加客户", "icon": "fas fa-plus" }
      },
      "pagination": {}
    }
  },
  "edit": {
    "primary": "id",
    "layout": {
      "fieldset": [
        {
          "columns": [
            { "name": "姓名", "width": 12 },
            { "name": "性别", "width": 3 },
            { "name": "生日", "width": 3 },
            { "name": "来源", "width": 3 },
            { "name": "状态", "width": 3 },
            { "name": "公司", "width": 24 },
            { "name": "介绍", "width": 24 }
          ]
        }
      ]
    },
    "actions": {
      "cancel": {},
      "save": { "@": "action.保存" },
      "delete": { "@": "action.删除" }
    }
  }
}
```

#### 启动服务

### MacOS / Linux

**在调试模式下，保存界面描述文件，会自动更新重启服务，刷新页面接口实时预览**，打开命令行终端，**在项目根录下运行**:

```bash
yao start
```

### Docker

```bash

# 运行容器 bash， 进入容器
docker exec -it <容器名称> /bin/bash

# 在容器中: 进入项目目录
cd /data/app

# 在容器中: 运行
yao start

```

#### 访问客户管理模块

打开浏览器, 访问 `https://127.0.0.1:5099/xiang/login/admin`，默认管理员名称密码为: 用户名: `xiang@iqka.com`，密码: `A123456p+`，成功登录后，在地址栏输入 `https://127.0.0.1:5099/xiang/table/customer` 即可访问客户管理模块。可以在菜单管理界面，将 `/xiang/table/customer` 路由添加为菜单项。

### 4. 自定义初始数据

在项目自动部署，发布时，可以使用数据流，设定菜单项，默认账号密码及创建初始数据，使用 `yao run` 命令运行，创建初始化脚本。在项目 `flows` 目录下，创建数据流描述文件 `init.flow.yao`：

```json
{
  "label": "初始化数据",
  "version": "1.0.0",
  "description": "初始化数据",
  "nodes": [
    {
      "name": "重建数据库",
      "process": "xiang.migrate"
    },
    {
      "name": "清空管理账号",
      "process": "models.xiang.user.DeleteWhere",
      "args": [{}]
    },
    {
      "name": "清空菜单",
      "process": "models.xiang.menu.DeleteWhere",
      "args": [{}]
    },
    {
      "name": "创建新管理账号",
      "process": "models.xiang.user.Save",
      "args": [
        {
          "name": "管理员",
          "type": "admin",
          "email": "xiang@yaoapp.com",
          "password": "A123456p+",
          "key": "8304925176",
          "secret": "XMTdNRVigbgUiAPdiJCfaWgWcz2PaQXw",
          "status": "enabled",
          "extra": { "sex": "男" }
        }
      ]
    },
    {
      "name": "添加菜单",
      "process": "models.xiang.menu.Insert",
      "args": [
        ["name", "path", "icon", "rank", "status"],
        [["客户管理", "/table/customer", "icon-users", 1, "enabled"]]
      ]
    }
  ]
}
```

打开命令行终端，**在项目根录下运行**:

```bash
yao run flows.init
```

打开浏览器, 访问 `https://127.0.0.1:5099/xiang/login/admin`，使用新用户名密码登录。

## 部署

### 1. 部署到云

打开命令行终端，**在项目根录下运行**:

```bash
yao publish -e online.env --cloud amazon flows.init
```

### 2. 部署指定服务器

```bash
yao publish -e online.env --ssh root@10.110.202.10 -i ~/.ssh/id_rsa flows.init
```

## 视频讲解

<Video src="https://player.bilibili.com/player.html?aid=507380047&bvid=BV1Sg411w7hs&cid=465617729&page=1"></Video>

## 相关内容

接下来，建议学习以下章节:

<Extend
  title="编写接口"
  desc="了解如何调用创建的 Model 来编写接口"
  link="/doc/c.基础特性/b.编写接口"
></Extend>

<Extend
  title="使用数据流"
  desc="进一步了解 Yao 中的所谓的数据流是什么"
  link="/doc/c.基础特性/e.编写数据流"
></Extend>

<!-- <Div style={{ display: 'flex', justifyContent: 'flex-end' }}>
	<Link type='next' title='为什么选择Yao' link='/doc/b.为什么选择Yao'></Link>
</Div> -->

<Div style={{ display: "flex", justifyContent: "space-between" }}>
  <Link
    type="prev"
    title="创建数据模型"
    link="/doc/c.基础特性/a.创建数据模型"
  ></Link>
  <Link type="next" title="描述界面" link="/doc/c.基础特性/c.描述界面"></Link>
</Div>
