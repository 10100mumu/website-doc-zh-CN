# 使用处理器

<blockquote>
  <p>
    Yao
    内建数据原子操作、网络请求、流程控制等一系列的处理器。这些处理器可以在数据接口、数据表格、数据图表、数据流等场景下使用，可以实现
    80% 的业务逻辑处理需求。
  </p>
  <p>处理器支持使用数据流、JS脚本、GRPC插件编写。</p>
</blockquote>

## 处理器

处理器是完成特定功能的函数 `Process( ...args:any[] ) any`, 由处理器名称、参数表和返回值构成。处理器包含以下类型：

| 处理器                 | 说明                                       |
| ---------------------- | ------------------------------------------ |
| yao.\*.\*              | 内建处理器                                 |
| models.<模型名称\>.\*  | 内建处理器，数据模型原子操作               |
| flows.<数据流名称\>    | 内建处理器，通过数据流编写的处理器         |
| scripts.<脚本名称\>.\* | 内建处理器，通过 JavaScript 脚本编写处理器 |
| plugins.<插件名称\>.\* | 通过 GRPC 插件编写处理器                   |
| session.\*             | 系统内建，会话数据处理器                   |

## 使用方式

### 在命令行中使用

可以使用 `run` 命令，运行处理器 `yao run <process> [args...]`。

```bash
yao run models.pet.Get '::{}'
```

### 在 API 中使用

在 API 中指定 `process` 设置处理器。 `query` 设置处理器的参数表。

```json
{
  ...
  "paths": [
    {
      "path": "/search",
      "method": "GET",
      "process": "models.pet.Paginate",
      "query": [":query-param", "$query.page", "$quey.pagesize"],
      "out": {
        "status": 200,
        "type": "application/json"
      }
    }
  ]
  ...
}
```

### 在数据流节点中使用

在数据流节点中通过 `process` 指定处理器， `args` 传入处理器参数表。

```json
{
  ...
  "nodes": [
    {
      "name": "宠物",
      "process": "models.pet.Find",
      "args": [1, { "select": ["id","name"] }]
    },
    {
      "name": "打印",
      "process": "yao.sys.Print",
      "args": ["{{$res.宠物}}"]
    }
  ]
  ...
}
```

同样方式也可以用在看板、大屏、图表的数据流节点上。

```json
{
  ...
  "nodes": [
    {
      "name": "类型汇总",
      "process": "flows.stat.kind",
       "args": [["狗","猫"]]
    }
  ]
  ...
}
```

扩展阅读:

<Extend
  title="编写数据流"
  desc="了解如何通过数据流，串联多次查询的上下文数据。"
  link="b.基础特性/e.编写数据流"
></Extend>

### 在数据表格中使用

使用 `process` 重载表格数据读取逻辑

```json
{
  ...
  "apis": {
    "search": {
      "process": "flows.pet.latest"
    },
    "find": {
      "process": "flows.pet.find"
    }
  }
  ...
}
```

用作表格 `Hook` ，处理上下文数据

```json
{
  ...
  "hooks": {
    "after:search": "flows.pet.fliter.data",
    "after:find": "flows.pet.fliter.row"
  }
  ...
}
```

扩展阅读:

<Extend
  title="自定义表格数据查询"
  desc="了解如何通过指定处理器，实现自定义表格数据接口。"
  link="b.基础特性/e.编写数据流"
></Extend>

<Extend
  title="表格中使用Hook"
  desc="了解如何通过指定处理器，实现表格的上下文数据处理。"
  link="b.基础特性/e.编写数据流"
></Extend>

<Div style={{ display: "flex", justifyContent: "space-between" }}>
  <Link type="prev" title="描述界面" link="b.基础特性/c.描述界面"></Link>
  <Link type="next" title="编写数据流" link="b.基础特性/e.编写数据流"></Link>
</Div>
<br />

## 内建处理器一览表

### 应用引擎

应用引擎相关处理器。

| 处理器             | 说明             | 文档                                    |
| ------------------ | ---------------- | --------------------------------------- |
| xiang.sys.Ping     | 返回 `PONG`      | [查看](../e.处理器参考/z.应用引擎#Find) |
| xiang.sys.Inspect  | 返回应用系统信息 | [查看](../e.处理器参考/z.应用引擎#Find) |
| xiang.sys.Print    | 在控制台打印数据 | [查看](../e.处理器参考/z.应用引擎#Find) |
| xiang.env.Get      | 读取环境变量     | [查看](../e.处理器参考/z.应用引擎#Find) |
| xiang.env.Set      | 设置环境变量     | [查看](../e.处理器参考/z.应用引擎#Find) |
| xiang.env.MultiSet | 批量设置环境变量 | [查看](../e.处理器参考/z.应用引擎#Find) |
| xiang.env.MultiGet | 批量读取环境变量 | [查看](../e.处理器参考/z.应用引擎#Find) |

<Notice type="warning">
  注意：应用引擎内建处理器命名空间为 <strong>xiang</strong> ,
  防止在命令行使用时与
  <strong>yao</strong> 混淆。 <strong>xiang</strong> 是应用引擎的内部研发代号, 名称源自周易
  <strong>《象传》[xiàng zhuàn]</strong>
  ，用来解释卦辞爻辞，取观测万象，预测趋势之意。
</Notice>

### 数据模型

数据模型原子操作处理器

| 处理器                                 | 说明                                                                       | 文档                                    |
| -------------------------------------- | -------------------------------------------------------------------------- | --------------------------------------- |
| models.<模型名称\>.Find                | 查询单条记录                                                               | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.Get                 | 按条件查询, 不分页                                                         | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.Paginate            | 按条件查询, 分页                                                           | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.Create              | 创建单条记录, 返回新创建记录 ID                                            | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.Update              | 更新单条记录                                                               | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.Save                | 保存单条记录, 不存在创建记录, 存在更新记录, 返回记录 ID                    | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.Delete              | 删除单条记录(标记删除)                                                     | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.Destroy             | 删除单条记录(真删除)                                                       | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.Insert              | 插入多条记录, 返回插入行数                                                 | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.UpdateWhere         | 按条件更新记录, 返回更新行数                                               | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.DeleteWhere         | 按条件删除数据, 返回删除行数(标记删除)                                     | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.DestroyWhere        | 按条件删除数据, 返回删除行数(真删除)                                       | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.EachSave            | 保存多条记录, 不存在创建记录, 存在更新记录, 返回记录 ID 集合               | [查看](../e.处理器参考/a.数据模型#Find) |
| models.<模型名称\>.EachSaveAfterDelete | 删除一组给定 ID 的记录后，保存多条记录, 不存在创建, 存在更新, 返回 ID 集合 | [查看](../e.处理器参考/a.数据模型#Find) |

### 网络请求

网络请求处理器

| 处理器                 | 说明                                          | 文档                                    |
| ---------------------- | --------------------------------------------- | --------------------------------------- |
| xiang.network.IP       | 查询服务器 IP 信息                            | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.network.Get      | 发送 HTTP GET 请求                            | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.network.Post     | 发送 HTTP POST 请求                           | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.network.PostJSON | 发送 HTTP POST 请求, payload 为 JSON 格式数据 | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.network.Put      | 发送 HTTP PUT 请求                            | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.network.PostJSON | 发送 HTTP PUT 请求, payload 为 JSON 格式数据  | [查看](../e.处理器参考/a.数据模型#Find) |

### 文件处理

文件处理器。

| 处理器            | 说明                       | 文档                                    |
| ----------------- | -------------------------- | --------------------------------------- |
| xiang.fs.Upload   | 上传文件到应用 `data` 目录 | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.fs.ReadFile | 读取 `data` 目录下文件内容 | [查看](../e.处理器参考/a.数据模型#Find) |

### 会话数据

用户会话数据处理器

| 处理器           | 说明             | 文档                                    |
| ---------------- | ---------------- | --------------------------------------- |
| session.Start    | 启用会话         | [查看](../e.处理器参考/a.数据模型#Find) |
| session.ID       | 读取会话 ID      | [查看](../e.处理器参考/a.数据模型#Find) |
| session.Get      | 读取会话变量     | [查看](../e.处理器参考/a.数据模型#Find) |
| session.Set      | 设置会话变量     | [查看](../e.处理器参考/a.数据模型#Find) |
| session.MultiSet | 批量设置会话变量 | [查看](../e.处理器参考/a.数据模型#Find) |
| session.Dump     | 返回所有会话数据 | [查看](../e.处理器参考/a.数据模型#Find) |

### 流程控制

| 处理器            | 说明               | 文档                                    |
| ----------------- | ------------------ | --------------------------------------- |
| xiang.flow.For    | 遍历数据           | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.flow.Each   | 遍历数据           | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.flow.Case   | Case 流程控制      | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.flow.IF     | IF 流程控制        | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.flow.Return | 返回输入数据       | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.flow.Throw  | 抛出异常并结束程序 | [查看](../e.处理器参考/a.数据模型#Find) |

### 数据表格

数据表格相关处理器。

| 处理器                  | 说明                                     | 文档                                    |
| ----------------------- | ---------------------------------------- | --------------------------------------- |
| xiang.table.Search      | 按条件查询, 分页。                       | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.Find        | 按主键查询单条数据。                     | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.Select      | 返回数据集合，匹配选择器组件数据结构。   | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.Save        | 保存单条记录，指定主键更新，不指定创建。 | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.Delete      | 按主键删除单条记录。                     | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.Insert      | 批量新增记录。                           | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.UpdateWhere | 批量更新符合条件的记录。                 | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.DeleteWhere | 批量删除符合条件的记录。                 | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.QuickSave   | 保存多条记录，指定主键更新，不指定创建。 | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.UpdateIn    | 批量更新指定一组主键的的数据记录。       | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.DeleteIn    | 批量删除指定一组主键的的数据记录。       | [查看](../e.处理器参考/b.数据表格#Find) |
| xiang.table.Setting     | 读取数据表格配置信息, 用于前端界面渲染   | [查看](../e.处理器参考/b.数据表格#Find) |

### 数据图表

数据看板、分析图表、数据大屏相关处理器。

| 处理器              | 说明                                   | 文档                                    |
| ------------------- | -------------------------------------- | --------------------------------------- |
| xiang.chart.Data    | 返回图表查询结果。                     | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.chart.Setting | 读取数据表格配置信息, 用于前端界面渲染 | [查看](../e.处理器参考/c.数据图表#Find) |

### 数据处理

| 处理器                        | 说明                                                            | 文档                                    |
| ----------------------------- | --------------------------------------------------------------- | --------------------------------------- |
| xiang.helper.ArrayGet         | 返回指定索引数据                                                | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.ArrayIndexes     | 返回数组索引。                                                  | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.ArrayPluck       | 将多个数据记录集合，合并为一个数据记录集合                      | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.ArraySplit       | 将多条数记录集合，分解为一个 fields:[]string 和 values: [][]any | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.ArrayColumn      | 返回多条数据记录，指定字段数值。                                | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.ArrayKeep        | 仅保留指定键名的数据                                            | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.ArrayTree        | 转换为树型结构                                                  | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.ArrayUnique      | 数组排重                                                        | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.ArrayMapSet      | 数组映射设定数值                                                | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.MapKeys          | 返回映射表的键                                                  | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.MapValues        | 返回映射表的数值                                                | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.MapToArray       | 映射转换为 KeyValue 数组                                        | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.MapGet           | 返回映射表给定键的值                                            | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.MapSet           | 设定键值,返回映射表给定键的值                                   | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.MapDel           | 删除给定键, 返回映射表                                          | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.MapMultiDel      | 删除一组给定键, 返回映射表                                      | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.StrConcat        | 连接字符串                                                      | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.Captcha          | 读取图形/音频验证码                                             | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.CaptchaValidate  | 校验图形/音频验证码                                             | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.PasswordValidate | 校验密码                                                        | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.JwtMake          | 制作 JWT                                                        | [查看](../e.处理器参考/c.数据图表#Find) |
| xiang.helper.JwtValidate      | 校验 JWT                                                        | [查看](../e.处理器参考/c.数据图表#Find) |

### 数据导入

| 处理器                      | 说明             | 文档                                    |
| --------------------------- | ---------------- | --------------------------------------- |
| xiang.import.Run            | 导入数据         | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.import.Data           | 数据预览         | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.import.Setting        | 查询导入配置     | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.import.DataSetting    | 查询数据预览配置 | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.import.Mapping        | 查询字段映射     | [查看](../e.处理器参考/a.数据模型#Find) |
| xiang.import.MappingSetting | 查询字段映射配置 | [查看](../e.处理器参考/a.数据模型#Find) |
