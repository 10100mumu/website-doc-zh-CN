# 编写接口

<blockquote>
  使用 API DSL 将处理器与 REST API 关联, 提供给外部系统访问。
</blockquote>

**约定**

1. 示例中约定应用根目录为 `/data/app`, 实际编写时需替换为应用根目录。
2. 示例中约定服务器地址为 `http://127.0.0.1:5099`, 实际编写时需自行替换。
3. 使用 `<>` 标识自行替换的内容。 例如: `icon-<图标名称>`, 实际编写时应替换为: `icon-foo`, `icon-bar` ...

## 编写 REST API

### 添加 API DSL 文件

在 `apis` 目录下, 创建一个 API DSL 文件, 关联 `models.product.Paginate` 处理器

`/data/app/apis/product.http.json`

```json
{
  "name": "产品",
  "version": "1.0.0",
  "description": "产品接口",
  "guard": "-",
  "group": "product",
  "paths": [
    {
      "path": "/search",
      "method": "GET",
      "process": "models.product.Paginate",
      "in": [":query-param", "$query.page", "$query.pagesize"],
      "out": { "status": 200, "type": "application/json" }
    },
    {
      "path": "/save",
      "method": "POST",
      "guard": "-",
      "process": "models.product.Save",
      "in": [":payload"],
      "out": { "status": 200, "type": "application/json" }
    }
  ]
}
```

**接口调试**

```bash
curl -X POST http://127.0.0.1:5099/api/product/save \
   -H 'Content-Type: application/json' \
   -d '{ "name":"沙丘六部曲", "remark":"(美) 弗兰克·赫伯特 "}'
```

```bash
curl 'http://127.0.0.1:5099/api/product/search?where.name.match=沙丘&page=1&pagesize=2'
```

### 使用 Guard

可以使用 Guard 实现 API 请求鉴权 如不希望使用 Guard, 将 `guard`字段设置为 `-`, 多个 `guard` 使用 `,` 分割。

Yao 提供 `bearer-jwt` 和 `cross-origin` Guard 用于 API JWT 鉴权和响应跨域请求。

修改 `/data/app/apis/product.http.json` DSL 文件，添加 Guard。

```json
{
  "name": "产品",
  "version": "1.0.0",
  "description": "产品接口",
  "guard": "bearer-jwt",
  "group": "product",
  "paths": [
    {
      "path": "/search",
      "guard": "-",
      "method": "GET",
      "process": "models.product.Paginate",
      "in": [":query-param", "$query.page", "$query.pagesize"],
      "out": { "status": 200, "type": "application/json" }
    },
    {
      "path": "/save",
      "method": "POST",
      "process": "models.product.Save",
      "in": [":payload"],
      "out": { "status": 200, "type": "application/json" }
    }
  ]
}
```

**接口调试**

```bash
# 没有权限
curl -X POST http://127.0.0.1:5099/api/product/save \
   -H 'Content-Type: application/json' \
   -d '{ "name":"沙丘六部曲", "remark":"(美) 弗兰克·赫伯特 "}'
#
#  {"code":403,"message":"No permission"}
#
```

```bash
curl 'http://127.0.0.1:5099/api/product/search?where.name.match=沙丘&page=1&pagesize=2'
```

生成 JWT

```bash
yao run yao.utils.JwtMake 1 '::{"id":1, "name":"Admin"}' '::{"issuer":"yao"}'
```

```bash
curl -X POST http://127.0.0.1:5099/api/product/save \
   -H 'Content-Type: application/json' \
   -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwic2lkIjoiZTZIODVMQ3Y5ODZZNVFsUG5lWWRGa1pPSUQ1LVFYYWxMX1pEazFLb0F3ND0iLCJkYXRhIjp7Imlzc3VlciI6InlhbyJ9LCJhdWQiOiJYaWFuZyBNZXRhZGF0YSBBZG1pbiBQYW5lbCIsImV4cCI6MTY2NzQ5NDg0MSwianRpIjoiMSIsImlhdCI6MTY2NzQ5MTI0MSwiaXNzIjoieGlhbmc6MSIsIm5iZiI6MTY2NzQ5MTI0MSwic3ViIjoiVXNlciBUb2tlbiJ9.AHv7OVeFZCTopWXPj1E__xVXal0oHdNYNrcoM93K8RI' \
   -d '{ "name":"沙丘六部曲", "remark":"(美) 弗兰克·赫伯特 "}'
```

### 使用自定义 Guard

Guard 支持自定义，可以使用脚本自定义 Guard, 可以用于接口权限管理。

**编写 Guard 逻辑**

在 `scirpts` 目录下, 新建一个 JS 文件, 实现自定义 Guard

`/data/app/scripts/guard.js`

```javascript
/**
 * 自定义接口鉴权
 * @param  {...any} args
 */
function User(path, params, query, payload, headers) {
  log.Trace("[guard.User] path: %v", path);
  log.Trace("[guard.User] params: %v", params);
  log.Trace("[guard.User] query: %v", query);
  log.Trace("[guard.User] payload: %v", payload);
  log.Trace("[guard.User] headers: %v", headers);
  query = query || {};
  if (query.error) {
    throw new Exception("没有权限", 403);
  }
}
```

**添加自定义 Guard**

修改 `/data/app/apis/product.http.json` DSL 文件，添加 Guard。

```json
{
  "name": "产品",
  "version": "1.0.0",
  "description": "产品接口",
  "guard": "bearer-jwt",
  "group": "product",
  "paths": [
    {
      "path": "/search",
      "guard": "-",
      "method": "GET",
      "process": "models.product.Paginate",
      "in": [":query-param", "$query.page", "$query.pagesize"],
      "out": { "status": 200, "type": "application/json" }
    },
    {
      "path": "/save",
      "guard": "bearer-jwt,scripts.guard.User",
      "method": "POST",
      "process": "models.product.Save",
      "in": [":payload"],
      "out": { "status": 200, "type": "application/json" }
    }
  ]
}
```

**接口调试**

生成 JWT

```bash
yao run yao.utils.JwtMake 1 '::{"id":1, "name":"Admin"}' '::{"issuer":"yao"}'
```

```bash
# 模拟没有权限
curl -X POST http://127.0.0.1:5099/api/product/save?error=1 \
   -H 'Content-Type: application/json' \
   -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwic2lkIjoiZTZIODVMQ3Y5ODZZNVFsUG5lWWRGa1pPSUQ1LVFYYWxMX1pEazFLb0F3ND0iLCJkYXRhIjp7Imlzc3VlciI6InlhbyJ9LCJhdWQiOiJYaWFuZyBNZXRhZGF0YSBBZG1pbiBQYW5lbCIsImV4cCI6MTY2NzQ5NDg0MSwianRpIjoiMSIsImlhdCI6MTY2NzQ5MTI0MSwiaXNzIjoieGlhbmc6MSIsIm5iZiI6MTY2NzQ5MTI0MSwic3ViIjoiVXNlciBUb2tlbiJ9.AHv7OVeFZCTopWXPj1E__xVXal0oHdNYNrcoM93K8RI' \
   -d '{ "name":"沙丘六部曲", "remark":"(美) 弗兰克·赫伯特 "}'
#
# {"code":403,"message":"没有权限"}
#
```

```bash
# 放行
curl -X POST http://127.0.0.1:5099/api/product/save \
   -H 'Content-Type: application/json' \
   -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwic2lkIjoiZTZIODVMQ3Y5ODZZNVFsUG5lWWRGa1pPSUQ1LVFYYWxMX1pEazFLb0F3ND0iLCJkYXRhIjp7Imlzc3VlciI6InlhbyJ9LCJhdWQiOiJYaWFuZyBNZXRhZGF0YSBBZG1pbiBQYW5lbCIsImV4cCI6MTY2NzQ5NDg0MSwianRpIjoiMSIsImlhdCI6MTY2NzQ5MTI0MSwiaXNzIjoieGlhbmc6MSIsIm5iZiI6MTY2NzQ5MTI0MSwic3ViIjoiVXNlciBUb2tlbiJ9.AHv7OVeFZCTopWXPj1E__xVXal0oHdNYNrcoM93K8RI' \
   -d '{ "name":"沙丘六部曲", "remark":"(美) 弗兰克·赫伯特 "}'
```

```bash
# 查看日志
tail -n 100 logs/application.log
```

[查看 API Widget 手册](../手册/Widgets/API)

<Div style={{ display: "flex", justifyContent: "space-between" }}>
  <Link type="prev" title="逻辑编排" link="基础/逻辑编排"></Link>
  <Link type="next" title="编写界面" link="基础/编写界面"></Link>
</Div>
